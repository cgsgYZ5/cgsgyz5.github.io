!function(t){"use strict";class e{canvas;id;gl;constructor(t){this.id=t,this.canvas=document.getElementById(t),null!=this.canvas?(this.gl=this.canvas.getContext("webgl2"),this.gl.cullFace(this.gl.FRONT_AND_BACK),this.gl.enable(this.gl.DEPTH_TEST)):this.gl=null}}class i{x;y;z;constructor(t,e,i){"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):null!=t&&null==e&&null==i?(this.x=t,this.y=t,this.z=t):null!=t&&null!=e&&null!=i?(this.x=t,this.y=e,this.z=i):(this.x=0,this.y=0,this.z=0)}set(t,e,i){return null!=t&&null!=e&&null!=i&&(this.x=t,this.y=e,this.z=i),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}mul(t){return this.x*=t,this.y*=t,this.z*=t,this}div(t){return 0==t?this.mul(0):(this.x/=t,this.y/=t,this.z/=t),this}len2(){return this.x*this.x+this.y*this.y+this.z*this.z}len(){return Math.sqrt(this.len2())}norm(){return this.div(this.len())}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return this.set(this.y*t.z-this.z*t.y,-this.x*t.z+this.z*t.x,this.x*t.y-this.y*t.x)}unpack(){return[this.x,this.y,this.z]}}function s(...t){return new i(...t)}class r{m=[[],[],[],[]];constructor(...t){this.set(...t)}set(){return 1===arguments.length?this.m=new[arguments[0],arguments[1],arguments[2],arguments[3]]:4===arguments.length?this.m=[arguments[0],arguments[1],arguments[2],arguments[3]]:16==arguments.length?this.m=[[arguments[0],arguments[1],arguments[2],arguments[3]],[arguments[4],arguments[5],arguments[6],arguments[7]],[arguments[8],arguments[9],arguments[10],arguments[11]],[arguments[12],arguments[13],arguments[14],arguments[15]]]:this.identity(),this}identity(){return this.m=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],this}view(t,e,i){const r=s(e).sub(t).norm(),a=s(r).cross(i).norm(),h=s(a).cross(r).norm();return this.set([a.x,h.x,-r.x,0],[a.y,h.y,-r.y,0],[a.z,h.z,-r.z,0],[-t.dot(a),-t.dot(h),t.dot(r),1]),this}translate(t){return this.m=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[t.x,t.y,t.z,1]],this}scale(t){return this.m=[[t.x,0,0,0],[0,t.y,0,0],[0,0,t.z,0],[0,0,0,1]],this}mul(t){return this.m=[[this.m[0][0]*t.m[0][0]+this.m[0][1]*t.m[1][0]+this.m[0][2]*t.m[2][0]+this.m[0][3]*t.m[3][0],this.m[0][0]*t.m[0][1]+this.m[0][1]*t.m[1][1]+this.m[0][2]*t.m[2][1]+this.m[0][3]*t.m[3][1],this.m[0][0]*t.m[0][2]+this.m[0][1]*t.m[1][2]+this.m[0][2]*t.m[2][2]+this.m[0][3]*t.m[3][2],this.m[0][0]*t.m[0][3]+this.m[0][1]*t.m[1][3]+this.m[0][2]*t.m[2][3]+this.m[0][3]*t.m[3][3]],[this.m[1][0]*t.m[0][0]+this.m[1][1]*t.m[1][0]+this.m[1][2]*t.m[2][0]+this.m[1][3]*t.m[3][0],this.m[1][0]*t.m[0][1]+this.m[1][1]*t.m[1][1]+this.m[1][2]*t.m[2][1]+this.m[1][3]*t.m[3][1],this.m[1][0]*t.m[0][2]+this.m[1][1]*t.m[1][2]+this.m[1][2]*t.m[2][2]+this.m[1][3]*t.m[3][2],this.m[1][0]*t.m[0][3]+this.m[1][1]*t.m[1][3]+this.m[1][2]*t.m[2][3]+this.m[1][3]*t.m[3][3]],[this.m[2][0]*t.m[0][0]+this.m[2][1]*t.m[1][0]+this.m[2][2]*t.m[2][0]+this.m[2][3]*t.m[3][0],this.m[2][0]*t.m[0][1]+this.m[2][1]*t.m[1][1]+this.m[2][2]*t.m[2][1]+this.m[2][3]*t.m[3][1],this.m[2][0]*t.m[0][2]+this.m[2][1]*t.m[1][2]+this.m[2][2]*t.m[2][2]+this.m[2][3]*t.m[3][2],this.m[2][0]*t.m[0][3]+this.m[2][1]*t.m[1][3]+this.m[2][2]*t.m[2][3]+this.m[2][3]*t.m[3][3]],[this.m[3][0]*t.m[0][0]+this.m[3][1]*t.m[1][0]+this.m[3][2]*t.m[2][0]+this.m[3][3]*t.m[3][0],this.m[3][0]*t.m[0][1]+this.m[3][1]*t.m[1][1]+this.m[3][2]*t.m[2][1]+this.m[3][3]*t.m[3][1],this.m[3][0]*t.m[0][2]+this.m[3][1]*t.m[1][2]+this.m[3][2]*t.m[2][2]+this.m[3][3]*t.m[3][2],this.m[3][0]*t.m[0][3]+this.m[3][1]*t.m[1][3]+this.m[3][2]*t.m[2][3]+this.m[3][3]*t.m[3][3]]],this}frustum(t,e,i,s,r,a){return this.m=[[2*r/(e-t),0,0,0],[0,2*r/(s-i),0,0],[(e+t)/(e-t),(s+i)/(s-i),-(a+r)/(a-r),-1],[0,0,-2*r*a/(a-r),0]],this}matrMulmatr(t,e){return this.m=[[t.m[0][0]*e.m[0][0]+t.m[0][1]*e.m[1][0]+t.m[0][2]*e.m[2][0]+t.m[0][3]*e.m[3][0],t.m[0][0]*e.m[0][1]+t.m[0][1]*e.m[1][1]+t.m[0][2]*e.m[2][1]+t.m[0][3]*e.m[3][1],t.m[0][0]*e.m[0][2]+t.m[0][1]*e.m[1][2]+t.m[0][2]*e.m[2][2]+t.m[0][3]*e.m[3][2],t.m[0][0]*e.m[0][3]+t.m[0][1]*e.m[1][3]+t.m[0][2]*e.m[2][3]+t.m[0][3]*e.m[3][3]],[t.m[1][0]*e.m[0][0]+t.m[1][1]*e.m[1][0]+t.m[1][2]*e.m[2][0]+t.m[1][3]*e.m[3][0],t.m[1][0]*e.m[0][1]+t.m[1][1]*e.m[1][1]+t.m[1][2]*e.m[2][1]+t.m[1][3]*e.m[3][1],t.m[1][0]*e.m[0][2]+t.m[1][1]*e.m[1][2]+t.m[1][2]*e.m[2][2]+t.m[1][3]*e.m[3][2],t.m[1][0]*e.m[0][3]+t.m[1][1]*e.m[1][3]+t.m[1][2]*e.m[2][3]+t.m[1][3]*e.m[3][3]],[t.m[2][0]*e.m[0][0]+t.m[2][1]*e.m[1][0]+t.m[2][2]*e.m[2][0]+t.m[2][3]*e.m[3][0],t.m[2][0]*e.m[0][1]+t.m[2][1]*e.m[1][1]+t.m[2][2]*e.m[2][1]+t.m[2][3]*e.m[3][1],t.m[2][0]*e.m[0][2]+t.m[2][1]*e.m[1][2]+t.m[2][2]*e.m[2][2]+t.m[2][3]*e.m[3][2],t.m[2][0]*e.m[0][3]+t.m[2][1]*e.m[1][3]+t.m[2][2]*e.m[2][3]+t.m[2][3]*e.m[3][3]],[t.m[3][0]*e.m[0][0]+t.m[3][1]*e.m[1][0]+t.m[3][2]*e.m[2][0]+t.m[3][3]*e.m[3][0],t.m[3][0]*e.m[0][1]+t.m[3][1]*e.m[1][1]+t.m[3][2]*e.m[2][1]+t.m[3][3]*e.m[3][1],t.m[3][0]*e.m[0][2]+t.m[3][1]*e.m[1][2]+t.m[3][2]*e.m[2][2]+t.m[3][3]*e.m[3][2],t.m[3][0]*e.m[0][3]+t.m[3][1]*e.m[1][3]+t.m[3][2]*e.m[2][3]+t.m[3][3]*e.m[3][3]]],this}pointTransform(t){return s(t.x*this.m[0][0]+t.y*this.m[1][0]+t.z*this.m[2][0]+this.m[3][0],t.x*this.m[0][1]+t.y*this.m[1][1]+t.z*this.m[2][1]+this.m[3][1],t.x*this.m[0][2]+t.y*this.m[1][2]+t.z*this.m[2][2]+this.m[3][2])}vecTransform(t){return s(t.x*this.m[0][0]+t.y*this.m[1][0]+t.z*this.m[2][0],t.x*this.m[0][1]+t.y*this.m[1][1]+t.z*this.m[2][1],t.x*this.m[0][2]+t.y*this.m[1][2]+t.z*this.m[2][2])}rotateX(t){const e=t*Math.PI/180;return this.m[1][1]=this.m[2][2]=Math.cos(e),this.m[1][2]=Math.sin(e),this.m[2][1]=-this.m[1][2],this}rotateY(t){const e=t*Math.PI/180;return this.m[0][0]=this.m[2][2]=Math.cos(e),this.m[2][0]=Math.sin(e),this.m[0][2]=-this.m[2][0],this}rotateZ(t){const e=t*Math.PI/180;return this.m[0][0]=this.m[1][1]=Math.cos(e),this.m[0][1]=-Math.sin(e),this.m[1][0]=-this.m[0][1],this}unpack(){return[this.m[0][0],this.m[0][1],this.m[0][2],this.m[0][3],this.m[1][0],this.m[1][1],this.m[1][2],this.m[1][3],this.m[2][0],this.m[2][1],this.m[2][2],this.m[2][3],this.m[3][0],this.m[3][1],this.m[3][2],this.m[3][3]]}ortho(t,e,i,s,r,a){return this.m=[[2/(e-t),0,0,0],[0,2/(s-i),0,0],[0,0,-2/(a-r),0],[-(e+t)/(e-t),-(s+i)/(s-i),-(a+r)/(a-r),1]],this}}function a(...t){return new r(...t)}function h(){const t=new Date;return t.getMilliseconds()/1e3+t.getSeconds()+60*t.getMinutes()}class m{globalTime;localTime;globalDeltaTime;localDeltaTime;startTime;oldTime;oldTimeFPS;frameCounter;isPause;FPS;pauseTime;constructor(){this.globalTime=this.localTime=h(),this.globalDeltaTime=this.localDeltaTime=0,this.startTime=this.oldTime=this.oldTimeFPS=this.globalTime,this.frameCounter=0,this.isPause=!1,this.FPS=30,this.pauseTime=0}response=(t=null)=>{let e=h();this.globalTime=e,this.globalDeltaTime=e-this.oldTime,this.isPause?(this.localDeltaTime=0,this.pauseTime+=e-this.oldTime):(this.localDeltaTime=this.globalDeltaTime,this.localTime=e-this.pauseTime-this.startTime),this.frameCounter++,e-this.oldTimeFPS>3&&(this.FPS=this.frameCounter/(e-this.oldTimeFPS),this.oldTimeFPS=e,this.frameCounter=0,null!=t&&(document.getElementById(t).innerHTML=this.getFPS())),this.oldTime=e};getFPS=()=>this.FPS.toFixed(3);allToMass(){return[this.globalTime,this.localTime,this.globalDeltaTime,this.localDeltaTime,this.isPause]}}class o{projSize;projDist;projFarClip;matrVP;matrView;matrProj;loc;at;dir;up;right;frameW;frameH;constructor(t){this.frameW=t.drawingBufferWidth,this.frameH=t.drawingBufferHeight,this.matrVP=a(),this.matrView=a(),this.matrProj=a(),this.loc=s(),this.at=s(),this.dir=s(),this.up=s(),this.right=s(),this.setProj(.5,.5,100),this.set(s(2),s(0),s(0,1,0))}set(t,e,i){this.matrView.view(t,e,i),this.matrVP.matrMulmatr(this.matrView,this.matrProj),this.loc=t,this.at=e,this.up=i,this.dir.set(-this.matrView.m[0][2],-this.matrView.m[1][2],-this.matrView.m[2][2]),this.up.set(-this.matrView.m[0][1],-this.matrView.m[1][1],-this.matrView.m[2][1]),this.right.set(-this.matrView.m[0][0],-this.matrView.m[1][0],-this.matrView.m[2][0])}setProj(t,e,i){let s,r;s=r=t,this.projDist=e,this.projSize=t,this.projFarClip=i,this.frameW>this.frameH?s*=this.frameW/this.frameH:r*=this.frameH/this.frameW,this.matrProj.frustum(-s/2,s/2,-r/2,r/2,e,i),this.matrVP.matrMulmatr(this.matrView,this.matrProj)}setSize(t,e){this.frameW=t,this.frameH=e,this.setProj(this.projSize,this.projDist,this.projFarClip)}update(t,e){let i=1==t.keys.Control,r=1==t.keys.Shift,h=e.globalDeltaTime,m=s(this.at).sub(this.loc).len(),o=(this.loc.y-this.at.y)/m,l=Math.sqrt(1-o*o),n=m*l,u=(this.loc.z-this.at.z)/n,c=(this.loc.x-this.at.x)/n,d=180/Math.PI*Math.atan2(c,u),f=180/Math.PI*Math.atan2(l,o),p=this.projSize,g=this.projSize,T=0,y=0,x=s();d+=h*i*1*-10*(500*(1==t.mButton[0])*t.mdx/(1+this.frameW)*2+(15+45*r)*((1==t.keys.ArrowLeft)-(1==t.keys.ArrowRight))),f+=h*i*1*-10*(500*(1==t.mButton[0])*t.mdy/(1+this.frameH)*2+((1==t.keys.ArrowUp)-(1==t.keys.ArrowDown))*(15+10*r)),f=Math.min(179.9,f),f=Math.max(.1,f),m+=h*i*1*(-t.mdz*(1+5*r)+(8+25*r)*((1==t.keys.PageUp)-(1==t.keys.PageDown))),m=Math.max(m,1.1),m=Math.min(m,10*this.projFarClip),this.frameW>this.frameH?p*=this.frameW/this.frameH:g*=this.frameH/this.frameW,1==t.mButton[2]&&i&&(T=t.mdx*p/this.frameW*m/this.projDist,y=-t.mdy*g/this.frameH*m/this.projDist,x=s(this.right).mul(T).add(s(this.up).mul(y)),this.at.add(x),this.loc.add(x)),1==t.keys.KeyF&&i?this.set(s(20),s(0),s(0,1,0)):(1==t.keys.KeyP&&i&&(e.isPause=!e.isPause),this.set(a().matrMulmatr(a().rotateX(f),a().rotateY(d)).mul(a().translate(this.at)).pointTransform(s(0,m,0)),this.at,s(0,1,0)))}allToMass(){return[...this.loc.unpack()]}}class l{canva;mx;my;mdx;mdy;mdz;mButton=[];keys=[];keysOld=[];keysClick=[];constructor(t){this.mdx=0,this.mdy=0,this.mdz=0,this.canva=t,t.addEventListener("wheel",this.mWheel,!1),t.addEventListener("mousemove",this.mMove,!1),t.addEventListener("mouseup",this.mUp,!1),t.addEventListener("mousedown",this.mDown,!1),t.addEventListener("contextmenu",(t=>t.preventDefault()),!1),window.addEventListener("mouseup",this.mUpW,!1),window.addEventListener("mousedown",this.mDownW,!1),window.addEventListener("keydown",this.keyDown,!1),window.addEventListener("keyup",this.keyUp,!1)}mUpW=t=>{this.mButton[t.button]=0};mDownW=t=>{this.mButton[t.button]=1};mWheel=t=>{this.mdz=t.deltaY,t.preventDefault()};mUp=t=>{this.mButton[t.button]=0};mDown=t=>{this.mButton[t.button]=1};mMove=t=>{this.mdx=t.movementX,this.mdy=t.movementY,this.mx=t.offsetX,this.my=t.offsetY};isSpecKey(t){if("Control"===t||"Alt"===t||"Shift"===t)return 0}keyDown=t=>{(t.altKey||t.ctrlKey||t.shiftKey)&&(this.keysOld[t.key]=0,this.keys[t.key]=1,0==this.keys[t.code]&&(this.keysClick[t.code]=1,this.keysClick[t.key]=1)),this.keysOld[t.code]=0,this.keys[t.code]=1};keyUp=t=>{this.keys[t.key]=this.isSpecKey(t.key),1==this.keys[t.code]?(this.keysClick[t.code]=1,null!=this.keys[t.key]&&(this.keysClick[t.key]=1)):this.keysClick[t.key]=0,this.keys[t.code]=0};reset(){this.keysClick=[],this.mdx=this.mdy=this.mdz=0}}class n{bindPoint;bufId;type;size;constructor(t,e,i){this.bufId=t.createBuffer(),this.type=e,t.bindBuffer(this.type,this.bufId),"number"==typeof i?(this.size=i,t.bufferData(this.type,4*i,t.STATIC_DRAW)):(this.size=i.length,t.bufferData(this.type,i,t.STATIC_DRAW))}update(t,e,i){t.bindBuffer(this.type,this.bufId),t.bufferSubData(this.type,e,i)}apply(t){t.bindBuffer(this.type,this.bufId)}}class u extends n{bindPoint;constructor(t,e,i){super(t,t.UNIFORM_BUFFER,e),this.size%16!=0&&console.error("buffer size not 16 * n"),this.bindPoint=i}apply(t,e,i){i<t.MAX_UNIFORM_BUFFER_BINDINGS&&(this.size<48&&t.bindBufferRange(t.UNIFORM_BUFFER,i,this.bufId,0,this.size),t.uniformBlockBinding(e,i,this.bindPoint),t.bindBufferBase(t.UNIFORM_BUFFER,this.bindPoint,this.bufId))}}function c(...t){return new n(...t)}function d(...t){return new u(...t)}async function f(t){const e=await fetch(t);return await e.text()}function p(t=null,e=null,i="triangle"){if(null==e||null==t)return[];let r=0;"triangle"===i&&(r=3),"triangle_strip"===i&&(r=1);let a,h,m,o,l=[];for(let e=0;e<t.length/3;e++)l.push(s(0));for(let i=0;i<e.length;i+=r)a=s(t[3*e[i]],t[3*e[i]+1],t[3*e[i]+2]),h=s(t[3*e[i+1]],t[3*e[i+1]+1],t[3*e[i+1]+2]),m=s(t[3*e[i+2]],t[3*e[i+2]+1],t[3*e[i+2]+2]),o=s(h).sub(a).cross(s(m).sub(a)).norm(),l[e[i]].add(o),l[e[i+1]].add(o),l[e[i+2]].add(o);let n=[];for(let t=0;t<l.length;t++)n.push(...l[t].norm().unpack());return n}let g=[];g.P=["in_pos","Position"],g.N=["in_norm","Normal"],g.T=["in_tex","Texture"],g.C=["in_color","Color"];class T{isCreated=!1;isDelete=!1;isDraw=!1;type;mTrans;mtl;VA;VB;IB=null;numOfV;create(t,e,i,s,r=null){if(this.type="triangle strip"==e?t.TRIANGLE_STRIP:"triangle"==e?t.TRIANGLES:t.POINTS,this.mtl=r,null!=r&&r.isCreate)return r.shd.isLoad?0==r.shd.isCreate?void this.error("prim have not shader"):(this.isCreated=!0,this.loadV(t,i,s,r),this):(r.shd.program.then((()=>{this.isCreated=!0,this.loadV(t,i,s,r)})),r.shd.program.catch((()=>(this.error("prim have not shader"),this))),this);this.error("prim have not material")}loadObjFromFile(t,e,i,s){return f(e).then((e=>{this.loadObjFromText(t,e,i,s)}))}loadObjFromText(t,e,i,s){if(null==e||null==e||""==e)return;const r=e.replace("\r").split("\n"),a=[],h=[];let m=0;for(let t=0;t<r.length;t++)"f "===r[t].slice(0,2)&&m++;for(let t=0;t<r.length;t++)if("v "===r[t].slice(0,2)){let e=r[t].split(" ");for(let t=1;t<4;t++)a.push(Number(e[t]))}else if("f "===r[t].slice(0,2)){let e=r[t].split(" ");for(let t=1;t<e.length;t++){let i=Number(e[t].split("//")[0]);i>0?h.push(i-1):h.push(m+i)}}this.create(t,i,{P:a,N:p(a,h)},h,s)}draw(t){this.isDraw=!0,null==t||null==t?(console.assertlog("trans matrix for draw is incorrect"),this.mTrans=a().identity()):this.mTrans=t}del(){this.isDelete=!0}convert(t,e){const i=[],s=[];for(let t=0;t<e.vertData.length;t++)s.push(0);let r;for(let i=0;i<e.vertData.length;i++)if(null!=t[e.vertData[i][0]]&&null!=t[e.vertData[i][0]]){r=t[e.vertData[i][0]].length/e.vertData[i][1];break}for(let i=0;i<e.vertData.length;i++)null!=t[e.vertData[i][0]]&&null!=t[e.vertData[i][0]]&&0!==t[e.vertData[i][0]].length||(t[e.vertData[i][0]]=void 0,console.log("fatall error not have"+e.vertData[i][0]+" in mas vert"));for(let a=0;a<r;a++)for(let r=0;r<s.length;r++)if(null!=t[e.vertData[r][0]])for(let a=0;a<e.vertData[r][1];a++)i.push(t[e.vertData[r][0]][s[r]++]);return i}loadV(t,e=null,i=null,s){if(this.numOfV=null==i||null==i?e.length:i.length,this.VA=t.createVertexArray(),t.bindVertexArray(this.VA),"number"!=typeof e[0]){for(let t=0;t<s.vertData.length;t++)null!=e[s.vertData[t][0]]&&null!=e[s.vertData[t][0]]&&0!==e[s.vertData[t][0]].length||(console.log(`in V massive no ${s.vertData[t][0]}`),s.allVertDataSize-=s.vertData[t][1]);e=this.convert(e,s)}if(null==e)return void this.error("have V in prim creating");this.VB=c(t,t.ARRAY_BUFFER,new Float32Array(e)),null!=i&&(this.IB=c(t,t.ELEMENT_ARRAY_BUFFER,new Int16Array(i)));let r=0;for(let e=0;e<s.vertData.length;e++)for(let i=0;i<g[s.vertData[e][0]].length;i++){const a=g[s.vertData[e][0]][i];if(null!=s.shd.info.attrs[a]){const i=s.shd.info.attrs[a].loc;t.vertexAttribPointer(i,s.vertData[e][1],t.FLOAT,!1,4*s.allVertDataSize,r),r+=4*s.vertData[e][1],t.enableVertexAttribArray(i);break}i==g[s.vertData[e][0]].length&&console.log(`shader have ${s.vertData[e][0]} but material patern have`)}}error(t=null){this.isCreated=!1,null!=t&&console.log(t)}}function y(t,e,i){const s=t.createShader(e);if(t.shaderSource(s,i),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS)){const e=t.getShaderInfoLog(s);return console.log("shader is not compieled"),console.log(e),null}return s}class x{isLoad=!1;isCreate=!1;pass;program;info={attrs:[],uniforms:[],uniformBlocks:[]};loadFromText(t,e,i){this.isLoad=!0;let s,r=!1;const a=y(t,t.VERTEX_SHADER,e),h=y(t,t.FRAGMENT_SHADER,i);return null==a||null==h?(r=!0,s="shader is not comriled"):(this.program=t.createProgram(),t.attachShader(this.program,a),t.attachShader(this.program,h),t.linkProgram(this.program),t.getProgramParameter(this.program,t.LINK_STATUS)?(this.getInfo(t),this.isCreate=!0):(s=t.getProgramInfoLog(this.program),r=!0)),r&&(this.isCreate=!1,this.program=null,console.log(s)),this}loadFromFile(t,e){return this.pass=e,this.program=new Promise(((i,s)=>{const r=f(e+"/vert.glsl"),a=f(e+"/frag.glsl");Promise.all([r,a]).then((e=>{this.isLoad=!0;let r,a=!1;const h=y(t,t.VERTEX_SHADER,e[0]),m=y(t,t.FRAGMENT_SHADER,e[1]);null==h||null==m?(a=!0,r="shader is not comriled"):(this.program=t.createProgram(),t.attachShader(this.program,h),t.attachShader(this.program,m),t.linkProgram(this.program),t.getProgramParameter(this.program,t.LINK_STATUS)?(this.getInfo(t),this.isCreate=!0,i(null)):(r=t.getProgramInfoLog(this.program),a=!0)),a&&(this.isCreate=!1,this.program=null,s(r))}))})),this}search(t,e){return t.forEach((t=>{if(t.pass==e)return t})),null}apply(t){this.isCreate&&t.useProgram(this.program)}getInfo(t){let e=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES);for(let i=0;i<e;i++){const e=t.getActiveAttrib(this.program,i);this.info.attrs[e.name]={name:e.name,type:e.type,size:e.size,loc:t.getAttribLocation(this.program,e.name)}}let i=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS);for(let e=0;e<i;e++){const i=t.getActiveUniform(this.program,e);this.info.uniforms[i.name]={name:i.name,type:i.type,size:i.size,loc:t.getUniformLocation(this.program,i.name)}}let s=t.getProgramParameter(this.program,t.ACTIVE_UNIFORM_BLOCKS);for(let e=0;e<s;e++){const i=t.getActiveUniformBlockName(this.program,e),s=t.getUniformBlockIndex(this.program,i);this.info.uniformBlocks[i]={name:i,index:s,size:t.getActiveUniformBlockParameter(this.program,s,t.UNIFORM_BLOCK_DATA_SIZE),bind:t.getActiveUniformBlockParameter(this.program,s,t.UNIFORM_BLOCK_BINDING),uIndex:t.getActiveUniformBlockParameter(this.program,s,t.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES),uNames:[],uniforms:[]},this.info.uniformBlocks[i].uOffset=t.getActiveUniforms(this.program,this.info.uniformBlocks[i].uIndex,t.UNIFORM_OFFSET);for(let e=0;e<this.info.uniformBlocks[i].uIndex.length;e++)this.info.uniformBlocks[i].uniforms[e]=this.info.uniforms[t.getActiveUniform(this.program,this.info.uniformBlocks[i].uIndex[e]).name]}}}function v(...t){return new x(...t)}class D{isCreate=!1;texture;url;type;constructor(){}loadCube(){}load2d(t,e){this.url=e,this.type=t.TEXTURE_2D,this.texture=t.createTexture(),this.promise=new Promise((()=>{const i=new Image;i.onload=()=>{this.promise=void 0,this.isCreate=!0,t.bindTexture(t.TEXTURE_2D,this.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i),Math.log(i.width)/Math.log(2)%1==0&&Math.log(i.height)/Math.log(2)%1==0?t.generateMipmap(t.TEXTURE_2D):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR))},i.src=e}))}search(t,e){return t.forEach((t=>{if(t.url==e)return t})),null}apply(t,e,i){1==this.isCreate&&i<t.MAX_UNIFORM_BUFFER_BINDINGS&&(t.activeTexture(this.type+e),t.bindTexture(this.type,this.texture),t.uniform1i(i,e))}texFlagUpdate(t,e,i){null!=this.promise?this.promise.then((()=>e.update(t,i,new Float32Array([1])))):e.update(t,i,new Float32Array([1]))}}function C(...t){return new D(...t)}const P="primMaterial";class w{gl;isCreate=!1;tex=[];shd;ubo=[];vertData=[];allVertDataSize=0;constructor(t,e,i,s,r,a,h,m=null){if(this.isCreate=!0,this.gl=t,"string"==typeof s?this.shd=v(t,e,s):"object"==typeof s?this.shd=s:(this.isCreate=!1,this.shd=null),null!=r&&null!=r){for(let t=0;t<r.length-1;t++)null!=r.at(-1)[r[t]]&&null!=r.at(-1)[r[t]]&&(this.vertData.push([r[t],r.at(-1)[r[t]]]),this.allVertDataSize+=r.at(-1)[r[t]]);0==this.allVertDataSize&&(this.isCreate=!1,this.vertData=null)}else this.isCreate=!1,this.vertData=null;if(null!=h&&null!=h)for(let e=0;e<h.length-1;e++)if(null!=h.at(-1)[h[e]]&&null!=h.at(-1)[h[e]]){let s=[h[e]],r=h.at(-1)[h[e]];"string"==typeof r?s.push(C(t,i,r)):s.push(r),this.tex.push(s)}else console.log("no have tex in tex mass");if(this.ubo.push(["primMatrix",d(t,48,0)]),null!=m&&null!=m)for(let t=0;t<m.length-1;t++)null!=m.at(-1)[m[t]]&&null!=m.at(-1)[m[t]]&&this.ubo.push([m[t],m.at(-1)[m[t]]]);const o=()=>{if(null==this.shd.info.uniformBlocks[P])return;let e=[],i=[],s=0;for(let r=0;r<this.shd.info.uniformBlocks[P].uniforms.length;r++){let h=this.shd.info.uniformBlocks[P].uniforms[r];if(null!=a)for(let t=0;t<a.length;t++)if(a[t]===h.name){"object"==typeof a.at(-1)[h.name]?e.push(...a.at(-1)[h.name]):e.push(a.at(-1)[h.name]),h=null;break}if(null!=h){for(let t=s;t<this.tex.length;t++)if(h.name=="isTex"+t){e.push(this.tex[t][1].isLoad),i.push([r,t]),s++,h=null;break}if(null!=h)if(h.type==t.FLOAT_VEC3||h.type==t.INT_VEC3)for(let t=0;t<3;t++)e.push(-1);else h.type!=t.FLOAT&&h.type!=t.INT||e.push(-1)}}if(null!=e){for(let t=0;t!=e.length%16;)e.push(-1);let s=d(t,new Float32Array(e),1);this.ubo.push([P,s]);for(let e=0;e<i.length;e++)this.tex[i[e][1]][1].texFlagUpdate(t,s,this.shd.info.uniformBlocks[P].uOffset[i[e][0]])}};this.isCreate?this.shd.isLoad&&this.shd.isCreate?o():this.shd.isLoad&&!this.shd.isCreate?(this.isCreate=!1,console.log("materia is not created")):(this.shd.program.then((()=>o())),this.shd.program.catch((()=>{this.isCreate=!1,console.log("materia is not created")}))):console.log("materia is not created")}apply(){if(this.isCreate){this.shd.apply(this.gl);for(let t=0;t<this.ubo.length;t++)null!=this.shd.info.uniformBlocks[this.ubo[t][0]]&&this.ubo[t][1].apply(this.gl,this.shd.program,this.shd.info.uniformBlocks[this.ubo[t][0]].index);for(let t=0;t<this.tex.length/2;t++)null!=this.shd.info.uniforms[this.tex[t][0]]&&this.tex[t][1].apply(this.gl,t,this.shd.info.uniforms[this.tex[t][0]].loc)}}}class b{allPrim=[];allTex=[];allShd=[];gl;timer;camera;input;constructor(t){this.gl=t.gl,this.camera=function(...t){return new o(...t)}(t.gl),this.timer=function(...t){return new m(...t)}(),this.input=function(...t){return new l(...t)}(t.canvas),this.dgColorSet(1,1,1,1)}dgColorSet(t,e,i,s){this.gl.clearColor(t,e,i,s)}uboCreate(...t){return d(this.gl,...t)}texCreate(...t){return C(this.gl,this.allTex,...t)}shdCreate(...t){return v(this.gl,this.allShd,...t)}mtlCreate(...t){return function(...t){return new w(...t)}(this.gl,this.allShd,this.allTex,...t)}prim(){const t=function(...t){return new T(...t)}();return this.allPrim.push(t),t}start(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.timer.response("fps")}end(){this.camera.update(this.input,this.timer),this.input.reset(),this.allPrim.forEach(((t,e)=>{t.isDraw&&!t.isDelete&&t.isCreated?this.primDraw(t):t.isDelete&&t.isCreated&&this.allPrim.splice(e,1)}))}primDraw(t){t.mtl.ubo.forEach((e=>{"primMatrix"==e[0]?e[1].update(this.gl,0,new Float32Array([...a().matrMulmatr(t.mTrans,this.camera.matrVP).unpack(),...this.camera.matrVP.unpack(),...t.mTrans.unpack()])):"time"==e[0]?e[1].update(this.gl,0,new Float32Array([...this.timer.allToMass()])):"camera"==e[0]&&e[1].update(this.gl,0,new Float32Array([...this.camera.allToMass()]))})),t.mtl.apply(),this.gl.bindVertexArray(t.VA),null!=t.IB?(t.IB.apply(this.gl),this.gl.drawElements(t.type,t.numOfV,this.gl.UNSIGNED_SHORT,0)):this.gl.drawArrays(t.type,0,t.numOfV)}}class E{drawContext;render;constructor(t){this.drawContext=function(...t){return new e(...t)}(t),this.render=function(...t){return new b(...t)}(this.drawContext)}}function _(...t){return new E(...t)}window.addEventListener("load",(()=>{let t=_("glCanvas"),e=t.drawContext.gl,i=t.render.uboCreate(16,2),s=t.render.uboCreate(16,3),r=t.render.mtlCreate(t.render.shdCreate().loadFromText(e,"#version 300 es\nprecision highp float;\n#define GLSLIFY 1\nin vec3 in_pos;in vec3 in_norm;in vec2 in_tex;out vec3 DrawPos;out vec2 TexCoords;out vec3 DrawNormal;out vec4 DrawColor;uniform primMatrix{mat4 WVP;mat4 VP;mat4 W;};void main(void){gl_Position=WVP*vec4(in_pos,1);DrawColor=vec4(WVP[0].x,WVP[0].x,WVP[0].x,WVP[0].x);DrawPos=vec3(W*vec4(in_pos,1));DrawColor=vec4(in_pos.rgb,1);TexCoords=in_tex;DrawNormal=vec3(inverse(transpose(W))*vec4(in_norm,1));}","#version 300 es\nprecision highp float;\n#define GLSLIFY 1\nuniform sampler2D uSampler1;uniform sampler2D uSampler2;uniform primMaterial{vec4 Ka4;vec4 Kd4;vec3 Ks;float Ph;float IsTex0,isTex1;};uniform time{float globalTime,localTime,globalDeltaTime,localDeltaTime,isPause;};uniform camera{vec3 loc;};\n#define Ka Ka4.rgb\n#define Kd Kd4.rgb\nout vec4 out_color;in vec2 TexCoords;in vec3 DrawPos;in vec4 DrawColor;in vec3 DrawNormal;vec3 shade(){vec3 L=normalize(vec3(5.0*sin(localTime),5,5.0*cos(localTime)));vec3 LC=vec3(0.1,0.2,0.7);vec3 V=normalize(DrawPos-loc);vec3 N=DrawNormal;return vec3(min(vec3(0.1),Ka)+max(0.05,dot(N,L))*Kd*LC+pow(max(0.05,dot(reflect(V,N),L)),Ph)*Ks*LC);}void main(void){out_color=vec4(1,0.6,0,1);vec3 col;if(IsTex0==1.)if(TexCoords.x<0.5&&TexCoords.y<0.5)col=texture(uSampler1,TexCoords.xy*2.0).rgb;else if(TexCoords.x>0.5&&TexCoords.y>0.5)col=texture(uSampler1,(TexCoords-0.5)*2.0).rgb;if(isTex1==1.)if(TexCoords.x<0.5&&TexCoords.y>0.5){col=texture(uSampler2,vec2(TexCoords.x,TexCoords.y*2.0-1.0)).rgb;}else{col=texture(uSampler2,vec2(TexCoords.x*2.0-1.0,TexCoords.y)).rgb;}out_color=vec4(col,1);if(IsTex0==-1.&&isTex1==-1.){vec3 L=normalize(-vec3(cos(localTime),1,sin(localTime)));vec3 LC=vec3(1,1,1);vec3 V=normalize(DrawPos-3.*vec3(cos(localTime),1,sin(localTime)));vec3 N=DrawNormal;vec3 R=reflect(V,N);vec3 a=max(0.1,dot(N,L))*Kd*LC+pow(max(0.1,dot(R,L)),Ph)*Ks*LC;col=Ka+a;out_color=vec4(col,1);}out_color=vec4(shade(),1);}"),["P","N",{P:3,N:3}],["Ka4","Kd4","Ks","Ph",{Ka4:[.1,.1,.1,-1],Kd4:[1,1,1,-1],Ks:[.7,.7,.7],Ph:40}],null,["time","camera",{time:i,camera:s}]),h=t.render.prim();h.loadObjFromFile(e,"./model/cow.obj","triangle",r).then((()=>{h.draw(a())})).catch((t=>{console.log(t)}));const m=()=>{t.render.start(),t.render.end(),window.requestAnimationFrame(m)};m()})),t.system=_}({});
